<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="run.scatter.botjde.scheduled.anniversary.mapper.AnniversaryMapper">

  <resultMap id="AnniversaryResultMap" type="run.scatter.botjde.entity.Anniversary">
    <result property="date" column="event_date" javaType="java.time.LocalDate" />
    <!-- Association for the people involved in the anniversary -->
    <collection property="users" ofType="run.scatter.botjde.entity.User">
      <constructor>
        <arg column="name" javaType="java.lang.String" />
        <arg column="username" javaType="java.lang.String" />
        <arg column="userId" javaType="java.lang.Long" />
      </constructor>
    </collection>
  </resultMap>

  <select id="getAllAnniversaries" resultMap="AnniversaryResultMap">
    SELECT
      e.id AS id,
      e.event_date AS event_date,
      p.name AS name,
      p.username AS username,
      p.userId
    FROM
      events e
    JOIN
      people_events pe ON e.id = pe.event_id
    JOIN
      people p ON pe.person_id = p.id
    WHERE
      e.type = 'anniversary'
    ORDER BY e.event_date;
  </select>

  <select id="getTodaysAnniversaries" resultMap="AnniversaryResultMap">
    SELECT
      e.id AS id,
      e.event_date AS event_date,
      p.name AS name,
      p.username AS username,
      p.userId
    FROM
      events e
    JOIN
      people_events pe ON e.id = pe.event_id
    JOIN
      people p ON pe.person_id = p.id
    WHERE
      e.type = 'anniversary'
      AND EXTRACT(MONTH FROM e.event_date) = EXTRACT(MONTH FROM CURRENT_DATE)
      AND EXTRACT(DAY FROM e.event_date) = EXTRACT(DAY FROM CURRENT_DATE)
    ORDER BY e.event_date;
  </select>

</mapper>
